name: ðŸš€ Content Validation & Auto-Deploy

on:
  push:
    branches: [main]
    paths:
      - 'content/blog/**'
      - 'content/projects.ts'
      - 'app/**'
      - 'components/**'
      - 'lib/**'
  pull_request:
    branches: [main]
    paths:
      - 'content/blog/**'
      - 'content/projects.ts'

jobs:
  validate-content:
    name: ðŸ“ Validate Blog Content
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: ðŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ðŸ” Lint Content Files
        run: |
          echo "ðŸ” Checking blog content structure..."
          
          # Check for required frontmatter in new blog posts
          for file in content/blog/*.md; do
            if [ -f "$file" ]; then
              echo "Validating: $file"
              
              # Check for required frontmatter fields
              if ! grep -q "^title:" "$file"; then
                echo "âŒ Missing 'title' in $file"
                exit 1
              fi
              
              if ! grep -q "^date:" "$file"; then
                echo "âŒ Missing 'date' in $file"
                exit 1
              fi
              
              if ! grep -q "^description:" "$file"; then
                echo "âŒ Missing 'description' in $file"
                exit 1
              fi
              
              echo "âœ… $file is valid"
            fi
          done
          
          echo "âœ… All blog content validated successfully!"
          
      - name: ðŸ—ï¸ Test Build
        run: |
          echo "ðŸ—ï¸ Testing production build..."
          npm run build
          echo "âœ… Build successful!"
          
      - name: ðŸ§ª Run Tests (if any)
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test -- --passWithNoTests
          else
            echo "â„¹ï¸ No tests configured"
          fi
          
  notify-deployment:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: validate-content
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ“Š Generate Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Content validated successfully**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ **Build completed**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± **Vercel will auto-deploy this commit**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Recent Changes:" >> $GITHUB_STEP_SUMMARY
          
          # List changed files
          git diff --name-only HEAD~1 HEAD | grep -E '\.(md|ts|tsx|js|jsx)$' | head -10 | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Live Site:** [pixel-wisdom-blog.vercel.app](https://pixel-wisdom-blog-echoexes-projects.vercel.app)" >> $GITHUB_STEP_SUMMARY 